{{ define "main" }}

<h1 class="notes-title">{{ .Title }}</h1>

{{ .Content }}

<!-- Tag filtering system -->
{{ $pages := .Pages.ByDate.Reverse }}
{{ $allTags := slice }}
{{ range $pages }}
  {{ range .Params.tags }}
    {{ $allTags = $allTags | append . }}
  {{ end }}
{{ end }}
{{ $uniqueTags := $allTags | uniq | sort }}

{{ if gt (len $uniqueTags) 0 }}
<div class="tag-container">
  <button class="tag-filter tag-filter-all active" data-tag="all">All</button>
  {{ range $uniqueTags }}
    <button class="tag-filter" data-tag="{{ . }}">{{ . }}</button>
  {{ end }}
</div>
{{ end }}

<div class="notes-feed">
  {{ range $index, $page := $pages }}
  <div id="note-{{ add $index 1 }}" class="note-card"
      {{ if $page.Params.tags }}
      data-tags="{{ delimit $page.Params.tags "," }}"
      {{ end }}>
    <div class="note-header">
      <div class="note-header-left">
        <span class="note-number">
          <a href="{{ $.Permalink }}#note-{{ add $index 1 }}">#{{ add $index 1 }}</a>
        </span>
        <h3 class="note-title">{{ .Title }}</h3>
      </div>
      {{ if not .Date.IsZero }}
      <span class="note-date">{{ .Date.Format "Jan 2, 2006" }}{{ if gt .Date.Hour 0 }} at {{ .Date.Format "3:04 PM" }}{{ end }}</span>
      {{ end }}
    </div>
    <div class="note-content">
      {{ .Content }}
    </div>

    {{ if .Params.tags }}
    <div class="note-tags">
      {{ range .Params.tags }}
        <a href="#" class="note-tag" data-tag="{{ . }}">{{ . }}</a>
      {{ end }}
    </div>
    {{ end }}

    {{ if and (not .Date.IsZero) (gt .Date.Unix 0) }}
    <div class="note-timestamp">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="note-icon">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <span>{{ .Date.Format "3:04 PM Â· Jan 2, 2006" }}</span>
    </div>
    {{ end }}
  </div>
  {{ end }}
</div>

<!-- JavaScript for tag filtering -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tagFilters = document.querySelectorAll('.tag-filter');
    const noteCards = document.querySelectorAll('.note-card');
    const noteTags = document.querySelectorAll('.note-tag');

    // Filter function
    function filterNotes(tag) {
      noteCards.forEach(card => {
        if (tag === 'all') {
          card.style.display = 'block';
        } else {
          const cardTags = card.dataset.tags ? card.dataset.tags.split(',') : [];
          if (cardTags.includes(tag)) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        }
      });
    }

    // Tag filter button click handler
    tagFilters.forEach(filter => {
      filter.addEventListener('click', function() {
        const tag = this.dataset.tag;

        // Update active state
        tagFilters.forEach(f => f.classList.remove('active'));
        this.classList.add('active');

        // Filter notes
        filterNotes(tag);
      });
    });

    // Note tag click handler
    noteTags.forEach(tag => {
      tag.addEventListener('click', function(e) {
        e.preventDefault();
        const tagValue = this.dataset.tag;

        // Find the corresponding filter button and trigger a click
        const tagFilter = document.querySelector(`.tag-filter[data-tag="${tagValue}"]`);
        if (tagFilter) {
          tagFilter.click();

          // Scroll to top of notes
          window.scrollTo({
            top: document.querySelector('.notes-title').offsetTop,
            behavior: 'smooth'
          });
        }
      });
    });
  });
</script>

{{ end }}
